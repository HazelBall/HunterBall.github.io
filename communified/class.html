<!doctype html>
<html>
	<head>
		<title>CommUnified Lite</title>
		<link rel = "stylesheet" type = "text/css" href = "style.css">
	</head>
	<body>
		<div class = "top">
			<h1>Communified</h1>
		</div>
		<div class = "side">
			<div class = "section nav">
				<strong>Hello, <em class = "displayName"></em>!</strong>
				<hr>
				<a href = "home.html">My Dashboard</a>
				<a href = "messages.html">My Messages</a>
				<a href = "user.html">My Profile</a>
				<hr>
				<a onclick = "logOut();">Log Out</a>
			</div>
			<hr>
			<div class = "section">
				<h4>Join a Class</h4>
				<input type = "text" size = "10" id = "classNewCode" placeholder = "Class Code"/>
				<button id = "classNewSubmit">Submit</button>
				<p>Teacher? <a href = "createClass.html">Create a class</a>.</p>
			</div>
		</div>
		<div class = "main">
			<h2 class = "className"></h2>
			<hr>
			<p>Code: <span class = "classCode"></span></p>
			<h4>Students</h4>
			<ul class = "classStudents"></ul>
			<h4>Teachers</h4>
			<ul class = "classTeachers"></ul>
		</div>
		<script src="https://www.gstatic.com/firebasejs/5.7.1/firebase.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyA74RowluDSPHcGfKclwIzbHGlrtYHVJ2k",
				authDomain: "communified-web.firebaseapp.com",
				databaseURL: "https://communified-web.firebaseio.com",
				projectId: "communified-web",
				storageBucket: "",
				messagingSenderId: "255197968272"
			};
			firebase.initializeApp(config);
			
			var userName = null;
			const db = firebase.firestore();
			const settings = {timestampsInSnapshots: true};
			db.settings(settings);
			var userDb = db.collection('users');
			var userDoc = null;
			var userId = null;
			// Class Variables
			var classDb = db.collection('classes');
			var classDoc = null;
			var classId = null;
			var className = null;
			var classDescription = null;
			var classStudents = null;
			var classTeachers = null;
			var classData = null;
			var classD = null;
			
			// Auth State
			firebase.auth().onAuthStateChanged(firebaseUser => {
				if(firebaseUser) {
					console.log(firebaseUser);
					userDoc = userDb.doc(firebaseUser.uid);
					userDoc.get().then(function(doc) {
						if(doc) {
							var data = doc.data();
							userName = data.userName;
							$('.displayName').text(userName);
						}
					});
					userId = firebaseUser.uid;
					getClass();
				} else {
					window.location.href = "signup.html";
				}
			});
			
			// Get Classes
			function getClass() {
				var urlParams = new URLSearchParams(window.location.search);
				classId = urlParams.get("id");
				console.log(classId);
				console.log(urlParams);
				if(classId == null) {
					window.location.href = "home.html";
				}
				classDoc = classDb.doc(classId);
				classDoc.get().then(function (doc) {
					if(doc) {
						classD = doc;
						console.log(doc.data());
						classData = doc.data();
						className = classData.name;
						classDescription = classData.desc;
						classStudents = classData.students;
						classTeachers = classData.teachers;
						changeWeb();
					}
				});
			}
			function changeWeb() {
				$('.classCode').text(classD.id);
				$('.className').text(className);
				$('.classDesc').text(classDescription);
				console.log(classStudents);
				for(var i = 0; i < classStudents.length; i ++) {
					var studentDoc = userDb.doc(classStudents[i]);
					var studentName;
					studentDoc.get().then(function(doc) {
						if(doc) {
							var data = doc.data();
							studentName = data.userName;
							console.log(studentName);
							var newObj = '<li><a href = "user.html?id='+ classStudents[i] + '">' + studentName + '</a></li>';
							$('.classStudents').append(newObj);
						}
					});
				}
				for(var i = 0; i < classTeachers.length; i ++) {
					var teacherDoc = userDb.doc(classTeachers[i]);
					var teacherName;
					teacherDoc.get().then(function(doc) {
						if(doc) {
							var data = doc.data();
							teacherName = data.userName;
							var newObj = '<li><a href = "user.html?id=' + classTeachers[i] + '">' + teacherName + '</a></li>';
							$('.classTeachers').append(newObj);
						}
					});
				}
			}
			// Log Out Function
			function logOut() {
				firebase.auth().signOut();
			}
		</script>
	</body>
</html>